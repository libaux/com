import{aG as e,K as a,aH as l,O as t,X as s,aI as n,aJ as o,aK as i,aL as r,H as u,aM as d,aN as c,o as v,c as x,w as h,b as y,p as g,f,g as p,F as m,r as b,n as _,aO as w,i as k,aP as T,L as E,j as S,e as C,l as R,t as $,u as D,k as H}from"./index-a54b26d9.js";import{_ as L}from"./plugin-vueexport-helper.1b428a4d.js";const B=L(e({name:"l-drag",externalClasses:["l-class"],options:{addGlobalClass:!0,virtualHost:!0},props:{list:{type:Array,default:[]},column:{type:Number,default:2},aspectRatio:Number,gridHeight:{type:[Number,String],default:"120rpx"},damping:{type:Number,default:40},friction:{type:Number,default:2},extraRow:{type:Number,default:0},ghost:Boolean,handle:Boolean,touchHandle:Boolean,before:Boolean,after:Boolean,disabled:Boolean,longpress:Boolean},emits:["change"],setup(e,{emit:v,expose:x}){const h=d(),y=a(!1),g=a(!1),f=a(!0),p=a(-1),m=a(-1),b=a(-1),_=a(!0),w=a(!(!e.handle&&!e.longpress)),k=l({content:null,index:0,oldindex:-1,lastindex:-1}),T=l({content:null,x:0,y:0}),E=l({x:0,y:0}),S=l({x:0,y:0});let C=[];const R=a(0),$=a([]),D=a(0),H=t((()=>(e.before?1:0)+(e.after?1:0))),L=t((()=>Math.ceil(((g.value?$.value.length:e.list.length)+H.value)/e.column))),B=t((()=>e.aspectRatio?I.value/e.aspectRatio:/rpx$/.test(`${e.gridHeight}`)?i(parseInt(`${e.gridHeight}`)):parseInt(`${e.gridHeight}`))),I=t((()=>R.value/e.column)),M=t((()=>({width:I.value+"px",height:B.value+"px"}))),N=t((()=>({height:(L.value+D.value)*B.value+"px"}))),A=t((()=>({height:(L.value+e.extraRow+D.value)*B.value+"px"}))),P=(e,a=1e3/60)=>setTimeout(e,a),j=(a,l)=>{p.value++,b.value++;const t=b.value,s=C[t];let n=0,o=0;if(s){if(e.after){let a=C[t+1];a||(a=F(C.length+(e.before?1:0)),C.push(a)),G((()=>K(a)))}else G();n=s.x,o=s.y}else{const a=F(C.length+(e.before?1:0));C.push(a),G(),n=a.x,o=a.y}return l&&(n=l.x,o=l.y),{id:`l-drag-item-${p.value}`,index:t,oldindex:t,content:a,x:n,y:o,class:"",show:!0}},G=e=>{g.value&&e&&P(e)},K=({x:a,y:l}={x:0,y:0})=>{e.after&&(S.x=a,S.y=l)},O=(a,l=!1)=>{const t=`${a.type}`.toLowerCase(),{handle:s=e.touchHandle}=a.target.dataset;e.handle&&!s?w.value=!0:e.handle&&s&&!e.longpress?w.value=l:(e.handle&&s&&e.longpress&&t.includes("longpress")||e.longpress&&t.includes("longpress")&&!e.handle)&&(w.value=!1),t.includes("touchend")&&e.longpress&&(w.value=!0)},F=(a,l)=>{let{row:t}=l||C[C.length-1]||{row:0};const s=a%e.column;return 0==s&&0!=a&&t++,n=t,o=s*I.value,i=t*B.value,{row:n,x:o,y:i,x1:o+I.value,y1:i+B.value};var n,o,i},J=()=>{const e=[...$.value].sort(((e,a)=>e.index-a.index));v("change",e)},X=(e,a,l,t=!0)=>{if(a>$.value.length-1||a<0)return;const s=(e=>y.value?k:$.value[e])(e);let n=0,o=s.index;if(o<a&&(n=1),o>a&&(n=-1),!n)return;let i=o-a;for(;i;){i+=n;const r=y.value?s.index+=n:o+=n;let u=$.value.findIndex((e=>e.index==r&&e.content!=s.content));if(u==e)return;u<0&&(u=$.value.length-1);let d=$.value[u];if(!d)return;const c=r-n,v=$.value[e],x=C[c];if(d.x=x.x,d.y=x.y,d.oldindex=d.index,d.index=c,v.oldindex=v.index,v.index=a,!i&&!y.value){const e=C[a],{x:n,y:o}=l||e;v.x=s.x=n,v.y=s.y=o,t&&J()}}},q=(e,a)=>{m.value=-1,y.value=!1,X(e,a)};let z=null;const Q=a=>{m.value=-1,y.value=!1,clearTimeout(z);const l=$.value[a];if(e.disabled||!l)return;l.show=!1;const t=$.value.length-1;X(a,t,l,!1),K(C[t]),b.value--;((l=a)=>{const t=Math.ceil(($.value.length-1+H.value)/e.column);t<L.value&&(D.value=L.value-t),$.value.splice(l,1)[0],J(),z=setTimeout((()=>{D.value=0}),400)})()},U=(...a)=>{e.disabled||Array.isArray(a)&&Promise.all(a.map((async e=>await V(e,!0)))).then(J)},V=(e,a)=>new Promise((l=>{const t=j(e,a?null:{x:-100,y:0});t.class="l-drag-enter",$.value.push(t);const s=$.value.length-1;r((()=>{P((()=>{t.class="l-drag-leave",X(s,a?s:0,null,!1),c($),l(!0)}))}))})),W=(...a)=>{e.disabled||Array.isArray(a)&&Promise.all(a.map((async e=>await V(e)))).then(J)},Y=()=>{g.value=y.value=!1,b.value=p.value=m.value=-1,$.value=[],C=[]},Z=()=>{Y(),(()=>{let a=[];const l=L.value*e.column+H.value;C=[];for(var t=0;t<l;t++){const e=F(t,a[a.length-1]);a.push(e)}if(e.before){const{x:e,y:l}=a.shift();E.x=e,E.y=l}K(a[e.list.length]),C=a})(),r((()=>{var a;a=e.list,$.value=a.map((e=>j(e))),g.value=!0}))};return s((()=>{u().in(h.proxy).select(".l-drag").boundingClientRect((e=>{e&&(R.value=e.width||0,Z())})).exec()})),n(Y),o((()=>e.list),Z),x({remove:Q,move:q,push:U,unshift:W,shift:()=>{$.value.length&&Q($.value.findIndex((e=>0==e.index))||0)},pop:()=>{const e=$.value.length-1;e<0||Q($.value.findIndex((a=>a.index==e))||e)}}),{cloneList:$,areaStyles:N,innerStyles:A,viewStyles:M,setDisabled:O,isDisabled:w,isReset:f,isDrag:y,active:m,animation:_,afterEl:S,ghostEl:T,beforeEl:E,touchStart:e=>{var a,l;if(e.target.dataset.remove)return;const{oindex:t}=(null==(a=e.currentTarget)?void 0:a.dataset)||(null==(l=e.target)?void 0:l.dataset)||{};if("number"!=typeof t)return;const s=$.value[t];y.value=!0,m.value=t,k.index=k.oldindex=s.index,T.x=s.x||0,T.y=s.y||0,k.content=T.content=s.content},touchMove:e=>{if(!y.value)return;let{oindex:a}=e.currentTarget.dataset;if(a!=m.value)return;const{x:l,y:t}=e.detail,s=l+I.value/2,n=t+B.value/2;for(let o=0;o<$.value.length;o++){const e=C[o];if(s>e.x&&s<e.x1&&n>e.y&&n<e.y1){T.x=e.x,T.y=e.y,k.index!=o&&X(m.value,o);break}}},touchEnd:e=>{setTimeout((()=>{if(e.target.dataset.remove||-1==m.value)return;O(e,!0),y.value=!1;const a=k.index!==k.oldindex&&k.oldindex>-1;k.lastindex=m.value,k.oldindex=m.value=-1;const l=$.value[k.lastindex],t=C[k.index];r((()=>{l.x=t.x+.001,l.y=t.y+.001,P((()=>{l.x=t.x,l.y=t.y,a&&J()}))}))}),80)},remove:Q,move:q,push:U,unshift:W,props:e}}}),[["render",function(e,a,l,t,s,n){const o=w,i=k,r=T;return v(),x(i,{class:"l-drag l-class",style:y([e.areaStyles]),ref:"dragRef",onTouchstart:e.setDisabled},{default:h((()=>[e.isReset?(v(),x(r,{key:0,class:"l-drag__inner",style:y([e.innerStyles])},{default:h((()=>[g(e.$slots,"default",{},void 0,!0),e.isDrag&&e.props.ghost?(v(),x(o,{class:"l-drag__ghost",animation:!0,style:y([e.viewStyles]),direction:"all",x:e.ghostEl.x,y:e.ghostEl.y,key:"l-drag-clone"},{default:h((()=>[g(e.$slots,"ghost",{},void 0,!0)])),_:3},8,["style","x","y"])):f("",!0),e.props.before?(v(),x(o,{key:1,class:"l-drag__before",disabled:"",animation:!1,style:y([e.viewStyles]),x:e.beforeEl.x,y:e.beforeEl.y},{default:h((()=>[g(e.$slots,"before",{},void 0,!0)])),_:3},8,["style","x","y"])):f("",!0),(v(!0),p(m,null,b(e.cloneList,((a,l)=>(v(),x(o,{key:a.id,direction:"all","data-oindex":l,style:y([e.viewStyles]),class:_(["l-drag__view",[{"l-is-active":l==e.active,"l-is-hidden":!a.show},a.class]]),x:a.x,y:a.y,friction:e.friction,damping:e.damping,animation:e.animation,disabled:e.isDisabled||e.props.disabled,onTouchstart:e.touchStart,onChange:e.touchMove,onTouchend:e.touchEnd,onTouchcancel:e.touchEnd,onLongpress:e.setDisabled},{default:h((()=>[g(e.$slots,"grid",{oindex:l,index:a.index,oldindex:a.oldindex,content:a.content,active:!e.isDisabled&&!e.isDisabled&&l==e.active},void 0,!0),e.isDisabled||e.props.disabled||!e.props.longpress?f("",!0):(v(),x(i,{key:0,class:"mask"}))])),_:2},1032,["data-oindex","style","class","x","y","friction","damping","animation","disabled","onTouchstart","onChange","onTouchend","onTouchcancel","onLongpress"])))),128)),e.props.after?(v(),x(o,{key:2,class:"l-drag__after",disabled:"",animation:!0,direction:"all",style:y([e.viewStyles]),x:e.afterEl.x,y:e.afterEl.y},{default:h((()=>[g(e.$slots,"after",{},void 0,!0)])),_:3},8,["style","x","y"])):f("",!0)])),_:3},8,["style"])):f("",!0)])),_:3},8,["style","onTouchstart"])}],["__scopeId","data-v-83a05f42"]]),I={__name:"setRandLib",setup(e){const l=a(null),t=new Array(7).fill(0).map(((e,a)=>a)),s=()=>{l.value.push(Math.round(1e3*Math.random()))};return(e,a)=>{const n=k,o=D,i=S(H("l-drag"),B);return v(),x(i,{list:E(t),onChange:e.change,ref_key:"dragRef",ref:l,after:"",remove:""},{grid:h((({active:a,index:t,oldindex:s,oindex:i})=>[C(n,{class:"remove",onClick:e=>(e=>{l.value&&e>=0&&l.value.remove(e)})(i)},null,8,["onClick"]),C(n,{class:_(["inner",{active:a}])},{default:h((()=>[C(o,{class:_(["text",{"text-active":a}])},{default:h((()=>[R($(e.content),1)])),_:2},1032,["class"])])),_:2},1032,["class"])])),after:h((()=>[C(n,{class:"grid"},{default:h((()=>[C(n,{class:"inner extra",onClick:s},{default:h((()=>[R(" 增加 ")])),_:1})])),_:1})])),_:1},8,["list","onChange"])}}};export{I as default};
